// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
}

enum PaymentStatus {
  PAID      // تم السداد
  UNPAID    // لم يتم السداد
  PARTIAL   // سداد جزئي
}

enum RequestStatus {
  PENDING   // في الانتظار
  ACCEPTED  // مقبول
  REJECTED  // مرفوض
}

enum AttendanceStatus {
  PRESENT    // ح - حاضرة
  EXCUSED    // م - غائبة بعذر (معتذرة)
  ABSENT     // غ - غائبة بدون عذر
  REVIEWED   // ر - راجعت بدون حضور
  LEFT_EARLY // خ - خروج مبكر
}

model User {
  id           String   @id @default(cuid())
  userName     String
  userEmail    String   @unique
  passwordHash String
  userRole     UserRole
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // العلاقات
  courses      Course[] @relation("TeacherCourses")
  student      Student? @relation("StudentUser")

  @@map("users")
}

model Program {
  id             String   @id @default(cuid())
  programName    String   // متسق مع userName
  programDescription String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // العلاقات
  courses        Course[]

  @@map("programs")
}

model Course {
  id              String   @id @default(cuid())
  courseName      String
  courseDescription String?
  syllabus        String?  // نصاب الحلقة (المنهج)
  level           Int      @default(1) // المستوى (1، 2، 3، إلخ)
  maxStudents     Int      @default(20)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // العلاقات
  programId    String
  program      Program  @relation(fields: [programId], references: [id], onDelete: Cascade)

  teacherId    String?
  teacher      User?    @relation("TeacherCourses", fields: [teacherId], references: [id], onDelete: SetNull)

  enrollmentRequests EnrollmentRequest[]
  enrollments        Enrollment[]
  attendances        Attendance[]
  dailyGrades        DailyGrade[]
  weeklyGrades       WeeklyGrade[]
  monthlyGrades      MonthlyGrade[]
  finalExams         FinalExam[]
  behaviorGrades     BehaviorGrade[]
  dailyTasks         DailyTask[]
  behaviorPoints     BehaviorPoint[]

  @@map("courses")
}

model Student {
  id               String        @id @default(cuid())
  studentNumber    Int           @unique // الرقم التسلسلي للطالبة (م)
  studentName      String        // اسم الطالبة الثلاثي
  qualification    String        // المؤهل الدراسي
  nationality      String        // الجنسية
  studentPhone     String        // رقم التواصل
  memorizedAmount  String        // مقدار الحفظ (مثل: جزء عم، 5 أجزاء، إلخ)
  paymentStatus    PaymentStatus @default(UNPAID) // حالة سداد الرسوم
  memorizationPlan String?       // خطة الحفظ
  notes            String?       // ملاحظات إضافية
  isActive         Boolean       @default(true)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // ربط الطالبة بمستخدم (للسماح بتسجيل الدخول)
  userId           String?       @unique
  user             User?         @relation("StudentUser", fields: [userId], references: [id], onDelete: SetNull)

  // العلاقات
  enrollmentRequests EnrollmentRequest[]
  enrollments        Enrollment[]
  attendances        Attendance[]
  dailyGrades        DailyGrade[]
  weeklyGrades       WeeklyGrade[]
  monthlyGrades      MonthlyGrade[]
  finalExams         FinalExam[]
  behaviorGrades     BehaviorGrade[]
  dailyTasks         DailyTask[]
  behaviorPoints     BehaviorPoint[]

  @@map("students")
}

model EnrollmentRequest {
  id        String        @id @default(cuid())
  status    RequestStatus @default(PENDING)
  message   String?       // رسالة اختيارية من الطالبة
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // العلاقات
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId]) // طالبة واحدة لا يمكن أن تطلب نفس الحلقة مرتين
  @@map("enrollment_requests")
}

model Enrollment {
  id          String   @id @default(cuid())
  enrolledAt  DateTime @default(now())
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // العلاقات
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId]) // طالبة واحدة لا يمكن أن تسجل في نفس الحلقة مرتين
  @@map("enrollments")
}

model Attendance {
  id        String           @id @default(cuid())
  date      DateTime         @default(now())         // تاريخ الحضور (اليوم)
  status    AttendanceStatus @default(PRESENT)       // حالة الحضور
  notes     String?                                   // ملاحظات إضافية
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // العلاقات
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // طالبة واحدة في حلقة واحدة في يوم واحد (تسجيل واحد فقط)
  @@unique([studentId, courseId, date])
  @@map("attendance")
}

model DailyGrade {
  id           String   @id @default(cuid())
  date         DateTime @default(now())         // تاريخ التقييم
  memorization Decimal  @default(0) @db.Decimal(4, 2) // حفظ وتجويد (0 - 5.00)
  review       Decimal  @default(0) @db.Decimal(4, 2) // مراجعة وتجويد (0 - 5.00)
  notes        String?                          // ملاحظات اختيارية
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // العلاقات
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // طالبة واحدة في حلقة واحدة في يوم واحد (درجة واحدة يومياً)
  @@unique([studentId, courseId, date])
  @@map("daily_grades")
}

model WeeklyGrade {
  id        String   @id @default(cuid())
  week      Int                               // الأسبوع (1-10)
  grade     Decimal  @default(0) @db.Decimal(4, 2) // درجة الأسبوع (0 - 5.00)
  notes     String?                          // ملاحظات اختيارية
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // العلاقات
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // طالبة واحدة في حلقة واحدة في أسبوع واحد (درجة أسبوعية واحدة)
  @@unique([studentId, courseId, week])
  @@map("weekly_grades")
}

model MonthlyGrade {
  id                  String   @id @default(cuid())
  month               Int                               // الشهر (1-3)
  quranForgetfulness  Decimal  @default(0) @db.Decimal(4, 2) // نسيان القرآن (0 - 5.00)
  quranMajorMistakes  Decimal  @default(0) @db.Decimal(4, 2) // لحن جلي (0 - 5.00)
  quranMinorMistakes  Decimal  @default(0) @db.Decimal(4, 2) // لحن خفي (0 - 5.00)
  tajweedTheory       Decimal  @default(0) @db.Decimal(4, 2) // التجويد النظري (0 - 15.00)
  notes               String?                          // ملاحظات اختيارية
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // العلاقات
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // طالبة واحدة في حلقة واحدة في شهر واحد (درجة شهرية واحدة)
  @@unique([studentId, courseId, month])
  @@map("monthly_grades")
}

model FinalExam {
  id           String   @id @default(cuid())
  quranTest    Decimal  @default(0) @db.Decimal(4, 2) // اختبار القرآن (0 - 40.00)
  tajweedTest  Decimal  @default(0) @db.Decimal(4, 2) // اختبار التجويد (0 - 20.00)
  notes        String?                          // ملاحظات اختيارية
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // العلاقات
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // طالبة واحدة في حلقة واحدة (اختبار نهائي واحد)
  @@unique([studentId, courseId])
  @@map("final_exams")
}

model BehaviorGrade {
  id           String   @id @default(cuid())
  date         DateTime                         // تاريخ التقييم
  dailyScore   Decimal  @default(0) @db.Decimal(3, 2) // درجة يومية (0 - 1.00)
  notes        String?                          // ملاحظات اختيارية
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // العلاقات
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // طالبة واحدة في حلقة واحدة في يوم واحد (درجة سلوك يومية واحدة)
  @@unique([studentId, courseId, date])
  @@map("behavior_grades")
}

model DailyTask {
  id                String   @id @default(cuid())
  date              DateTime                         // تاريخ المهام
  listening5Times   Boolean  @default(false)         // السماع 5 مرات (5 نقاط)
  repetition10Times Boolean  @default(false)         // التكرار 10 مرات (5 نقاط)
  recitedToPeer     Boolean  @default(false)         // السرد على الرفيقة (5 نقاط)
  notes             String?                          // ملاحظات اختيارية
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // العلاقات
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // طالبة واحدة في حلقة واحدة في يوم واحد (مهام يومية واحدة)
  @@unique([studentId, courseId, date])
  @@map("daily_tasks")
}

model BehaviorPoint {
  id              String   @id @default(cuid())
  date            DateTime                         // تاريخ التقييم
  earlyAttendance Boolean  @default(false)         // الحضور المبكر (5 نقاط)
  perfectMemorization Boolean @default(false)      // الحفظ المتقن (5 نقاط)
  activeParticipation Boolean @default(false)      // المشاركة الفعالة (5 نقاط)
  timeCommitment  Boolean  @default(false)         // الالتزام بالحضور حتى نهاية الوقت (5 نقاط)
  notes           String?                          // ملاحظات اختيارية
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // العلاقات
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // طالبة واحدة في حلقة واحدة في يوم واحد (نقاط سلوكية يومية واحدة)
  @@unique([studentId, courseId, date])
  @@map("behavior_points")
}
